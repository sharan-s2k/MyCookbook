# LOCAL DEVELOPMENT ONLY - DO NOT USE IN PRODUCTION
# This file orchestrates all services for local development
# Each service can also run standalone with its own docker-compose.yml

version: '3.8'

services:
  # Infrastructure
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092,PLAINTEXT_INTERNAL://kafka:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT_INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 5s
      retries: 5

  opensearch:
    image: opensearchproject/opensearch:2.11.0
    environment:
      - discovery.type=single-node
      - plugins.security.disabled=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
      - "9600:9600"
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s

  # Databases
  auth-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: auth_pass
    ports:
      - "5433:5432"
    volumes:
      - auth-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U auth_user -d auth_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  user-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: user_db
      POSTGRES_USER: user_user
      POSTGRES_PASSWORD: user_pass
    ports:
      - "5434:5432"
    volumes:
      - user-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user_user -d user_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  recipe-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: recipe_db
      POSTGRES_USER: recipe_user
      POSTGRES_PASSWORD: recipe_pass
    ports:
      - "5435:5432"
    volumes:
      - recipe-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U recipe_user -d recipe_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  cookbook-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: cookbook_db
      POSTGRES_USER: cookbook_user
      POSTGRES_PASSWORD: cookbook_pass
    ports:
      - "5436:5432"
    volumes:
      - cookbook-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cookbook_user -d cookbook_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Services
  auth:
    build:
      context: ./auth
      dockerfile: Dockerfile
    depends_on:
      auth-db:
        condition: service_healthy
      user:
        condition: service_started
    # Internal service - no public port exposure
    expose:
      - "8001"
    environment:
      PORT: 8001
      DATABASE_URL: postgres://auth_user:auth_pass@auth-db:5432/auth_db
      JWT_SECRET: ${JWT_SECRET:-dev-secret-change-in-production}
      ACCESS_TOKEN_TTL_MIN: 15
      REFRESH_TOKEN_TTL_DAYS: 30
      USER_SERVICE_INTERNAL_URL: http://user:8002
      SERVICE_TOKEN: ${SERVICE_TOKEN:-dev-service-token}
      BCRYPT_COST: 12
    volumes:
      - ./auth:/app
      - /app/node_modules

  user:
    build:
      context: ./user
      dockerfile: Dockerfile
    depends_on:
      user-db:
        condition: service_healthy
      kafka:
        condition: service_healthy
    # Internal service - no public port exposure
    expose:
      - "8002"
    environment:
      PORT: 8002
      DATABASE_URL: postgres://user_user:user_pass@user-db:5432/user_db
      KAFKA_BROKERS: kafka:29092
      KAFKA_TOPIC_USERS: user.events
      SERVICE_TOKEN: ${SERVICE_TOKEN:-dev-service-token}
      GATEWAY_TOKEN: ${GATEWAY_TOKEN:-${SERVICE_TOKEN:-dev-service-token}}
    volumes:
      - ./user:/app
      - /app/node_modules

  recipe:
    build:
      context: ./recipe
      dockerfile: Dockerfile
    depends_on:
      recipe-db:
        condition: service_healthy
      kafka:
        condition: service_healthy
      cookbook:
        condition: service_started
    # Internal service - no public port exposure
    expose:
      - "8003"
    environment:
      PORT: 8003
      DATABASE_URL: postgres://recipe_user:recipe_pass@recipe-db:5432/recipe_db
      KAFKA_BROKERS: kafka:29092
      KAFKA_TOPIC_JOBS: recipe.jobs
      SERVICE_TOKEN: ${SERVICE_TOKEN:-dev-service-token}
      GATEWAY_TOKEN: ${GATEWAY_TOKEN:-${SERVICE_TOKEN:-dev-service-token}}
      COOKBOOK_SERVICE_URL: http://cookbook:8006
    volumes:
      - ./recipe:/app
      - /app/node_modules

  cookbook:
    build:
      context: ./cookbook
      dockerfile: Dockerfile
    depends_on:
      cookbook-db:
        condition: service_healthy
    # Internal service - no public port exposure
    expose:
      - "8006"
    environment:
      PORT: 8006
      DATABASE_URL: postgres://cookbook_user:cookbook_pass@cookbook-db:5432/cookbook_db
      SERVICE_TOKEN: ${SERVICE_TOKEN:-dev-service-token}
      GATEWAY_TOKEN: ${GATEWAY_TOKEN:-${SERVICE_TOKEN:-dev-service-token}}
      RECIPE_SERVICE_URL: http://recipe:8003
    volumes:
      - ./cookbook:/app
      - /app/node_modules

  ai-orchestrator:
    build:
      context: ./ai-orchestrator
      dockerfile: Dockerfile
    # Internal service - no public port exposure
    expose:
      - "8004"
    environment:
      PORT: 8004
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      GEMINI_MODEL: ${GEMINI_MODEL:-gemini-2.5-flash}
      REQUEST_TIMEOUT_SEC: 60
      FRONTEND_ORIGIN: http://localhost:3000
      SERVICE_TOKEN: ${SERVICE_TOKEN:-dev-service-token}
    volumes:
      - ./ai-orchestrator:/app

  workers:
    build:
      context: ./workers
      dockerfile: Dockerfile
    depends_on:
      kafka:
        condition: service_healthy
      recipe:
        condition: service_started
      ai-orchestrator:
        condition: service_started
    # Internal service - no public port exposure
    expose:
      - "8005"
    environment:
      KAFKA_BROKERS: kafka:29092
      KAFKA_TOPIC_JOBS: recipe.jobs
      RECIPE_INTERNAL_URL: http://recipe:8003
      AI_ORCHESTRATOR_URL: http://ai-orchestrator:8004
      SERVICE_TOKEN: ${SERVICE_TOKEN:-dev-service-token}
      WORKER_CONCURRENCY: ${WORKER_CONCURRENCY:-4}
    volumes:
      - ./workers:/app
      - /app/node_modules

  search:
    build:
      context: ./search
      dockerfile: Dockerfile
    depends_on:
      opensearch:
        condition: service_healthy
      kafka:
        condition: service_healthy
    expose:
      - "8007"
    environment:
      PORT: 8007
      OPENSEARCH_URL: http://opensearch:9200
      OPENSEARCH_INDEX_NAME: ${OPENSEARCH_INDEX_NAME:-cookflow_search}
      KAFKA_BROKERS: kafka:29092
      KAFKA_TOPIC_USERS: user.events
      KAFKA_TOPIC_RECIPES: recipe.events
      SERVICE_TOKEN: ${SERVICE_TOKEN:-dev-service-token}
      GATEWAY_TOKEN: ${GATEWAY_TOKEN:-${SERVICE_TOKEN:-dev-service-token}}
      USER_SERVICE_URL: http://user:8002
      RECIPE_SERVICE_URL: http://recipe:8003
    volumes:
      - ./search:/app
      - /app/node_modules

  feed:
    build:
      context: ./feed
      dockerfile: Dockerfile
    depends_on:
      user:
        condition: service_started
      cookbook:
        condition: service_started
    expose:
      - "8008"
    environment:
      PORT: 8008
      SERVICE_TOKEN: ${SERVICE_TOKEN:-dev-service-token}
      GATEWAY_TOKEN: ${GATEWAY_TOKEN:-${SERVICE_TOKEN:-dev-service-token}}
      USER_INTERNAL_URL: http://user:8002
      COOKBOOK_INTERNAL_URL: http://cookbook:8006
      HTTP_TIMEOUT_MS: 3000
      MAX_OWNER_IDS: 500
    volumes:
      - ./feed:/app
      - /app/node_modules

  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    depends_on:
      auth:
        condition: service_started
      user:
        condition: service_started
      recipe:
        condition: service_started
      cookbook:
        condition: service_started
      ai-orchestrator:
        condition: service_started
      search:
        condition: service_started
      feed:
        condition: service_started
    ports:
      - "8080:8080"
    environment:
      PORT: 8080
      AUTH_URL: http://auth:8001
      USER_URL: http://user:8002
      RECIPE_URL: http://recipe:8003
      COOKBOOK_URL: http://cookbook:8006
      AI_ORCHESTRATOR_URL: http://ai-orchestrator:8004
      SEARCH_URL: http://search:8007
      FEED_URL: http://feed:8008
      JWT_PUBLIC_OR_SHARED_SECRET: ${JWT_SECRET:-dev-secret-change-in-production}
      SERVICE_TOKEN: ${SERVICE_TOKEN:-dev-service-token}
      GATEWAY_TOKEN: ${GATEWAY_TOKEN:-${SERVICE_TOKEN:-dev-service-token}}
      FRONTEND_ORIGIN: http://localhost:3000
      GATEWAY_UPSTREAM_TIMEOUT_MS: ${GATEWAY_UPSTREAM_TIMEOUT_MS:-5000}
      CORS_MAX_AGE_SECONDS: ${CORS_MAX_AGE_SECONDS:-600}
    volumes:
      - ./gateway:/app
      - /app/node_modules

volumes:
  auth-db-data:
  user-db-data:
  recipe-db-data:
  cookbook-db-data:
  opensearch-data:

